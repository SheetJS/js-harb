/* harb.js (C) 2014-present  SheetJS -- http://sheetjs.com */
var HARB={};(function make_harb(HARB){HARB.version="0.1.0";if(typeof exports!=="undefined"){if(typeof module!=="undefined"&&module.exports){babyParse=require("babyparse");cptable=require("./dist/cpharb");SSF=require("ssf");fs=require("fs")}}function datenum(v,date1904){var epoch=v.getTime();if(date1904)epoch+=1462*24*60*60*1e3;return(epoch+22091616e5)/(24*60*60*1e3)}function numdate(v){var date=SSF.parse_date_code(v);var val=new Date;if(date==null)throw new Error("Bad Date Code: "+v);val.setUTCDate(date.d);val.setUTCMonth(date.m-1);val.setUTCFullYear(date.y);val.setUTCHours(date.H);val.setUTCMinutes(date.M);val.setUTCSeconds(date.S);return val}var sheet_to_workbook=function(sheet){return{SheetNames:["Sheet1"],Sheets:{Sheet1:sheet}}};function aoa_to_sheet(data,opts){var o=opts||{};var ws={};var range={s:{c:1e7,r:1e7},e:{c:0,r:0}};for(var R=0;R!=data.length;++R){for(var C=0;C!=data[R].length;++C){if(range.s.r>R)range.s.r=R;if(range.s.c>C)range.s.c=C;if(range.e.r<R)range.e.r=R;if(range.e.c<C)range.e.c=C;var cell={v:data[R][C]};if(cell.v==null)continue;var cell_ref=encode_cell({c:C,r:R});if(typeof cell.v==="number")cell.t="n";else if(typeof cell.v==="boolean")cell.t="b";else if(cell.v instanceof Date){cell.t="n";cell.z=o.dateNF||SSF._table[14];cell.v=datenum(cell.v)}else cell.t="s";ws[cell_ref]=cell}}if(range.s.c<1e7)ws["!ref"]=encode_range(range);return ws}var bpopts={dynamicTyping:true,keepEmptyRows:true};var csv_to_aoa=function(str){var data=babyParse.parse(str,bpopts).data;for(var R=0;R!=data.length;++R)for(var C=0;C!=data[R].length;++C){var d=data[R][C];if(d==="")data[R][C]=null;else if(d==="TRUE")data[R][C]=true;else if(d==="FALSE")data[R][C]=false}return data};var csv_to_sheet=function(str){return aoa_to_sheet(csv_to_aoa(str))};var csv_to_workbook=function(str){return sheet_to_workbook(csv_to_sheet(str))};function set_text_arr(data,arr,R,C){if(data==="TRUE")arr[R][C]=true;else if(data==="FALSE")arr[R][C]=false;else if(+data==+data)arr[R][C]=+data;else if(data!=="")arr[R][C]=data}var prn_to_aoa=function(f){var arr=[];if(!f||f.length===0)return arr;var lines=f.split(/[\r\n]/);var L=lines.length-1;while(L>=0&&lines[L].length===0)--L;var start=10,idx=0;var R=0;for(;R<=L;++R){idx=lines[R].indexOf(" ");if(idx==-1)idx=lines[R].length;else idx++;start=Math.max(start,idx)}for(R=0;R<=L;++R){arr[R]=[];var C=0;set_text_arr(lines[R].slice(0,start).trim(),arr,R,C);for(C=1;C<=(lines[R].length-start)/10+1;++C)set_text_arr(lines[R].slice(start+(C-1)*10,start+C*10).trim(),arr,R,C)}return arr};var prn_to_sheet=function(str){return aoa_to_sheet(prn_to_aoa(str))};var prn_to_workbook=function(str){return sheet_to_workbook(prn_to_sheet(str))};var dif_to_aoa=function(str){var records=str.split("\n"),R=-1,C=-1,ri=0,arr=[];for(;ri!==records.length;++ri){if(records[ri].trim()==="BOT"){arr[++R]=[];C=0;continue}if(R<0)continue;var metadata=records[ri].trim().split(",");var type=metadata[0],value=metadata[1];++ri;var data=records[ri].trim();switch(+type){case-1:if(data==="BOT"){arr[++R]=[];C=0;continue}else if(data!=="EOD")throw new Error("Unrecognized DIF special command "+data);break;case 0:if(data==="TRUE")arr[R][C]=true;else if(data==="FALSE")arr[R][C]=false;else if(+value==+value)arr[R][C]=+value;else arr[R][C]=value;++C;break;case 1:data=data.substr(1,data.length-2);arr[R][C++]=data!==""?data:null;break}if(data==="EOD")break}return arr};var dif_to_sheet=function(str){return aoa_to_sheet(dif_to_aoa(str))};var dif_to_workbook=function(str){return sheet_to_workbook(dif_to_sheet(str))};var sylk_to_aoa=function(str){var records=str.split(/[\n\r]+/),R=-1,C=-1,ri=0,rj=0,arr=[];var formats=[];var next_cell_format=null;for(;ri!==records.length;++ri){var record=records[ri].trim().split(";");var RT=record[0],val;if(RT==="P")for(rj=1;rj<record.length;++rj)switch(record[rj].charAt(0)){case"P":formats.push(record[rj].substr(1));break}else if(RT!=="C"&&RT!=="F")continue;else for(rj=1;rj<record.length;++rj)switch(record[rj].charAt(0)){case"Y":R=parseInt(record[rj].substr(1))-1;C=0;for(var j=arr.length;j<=R;++j)arr[j]=[];break;case"X":C=parseInt(record[rj].substr(1))-1;break;case"K":val=record[rj].substr(1);if(val.charAt(0)==='"')val=val.substr(1,val.length-2);else if(val==="TRUE")val=true;else if(val==="FALSE")val=false;else if(+val===+val){val=+val;if(next_cell_format!==null&&next_cell_format.match(/[ymdhmsYMDHMS]/))val=numdate(val)}arr[R][C]=val;next_cell_format=null;break;case"P":if(RT!=="F")break;next_cell_format=formats[parseInt(record[rj].substr(1))]}}return arr};var sylk_to_sheet=function(str){return aoa_to_sheet(sylk_to_aoa(str))};var sylk_to_workbook=function(str){return sheet_to_workbook(sylk_to_sheet(str))};var socialcalc_to_aoa=function(str){var records=str.split("\n"),R=-1,C=-1,ri=0,arr=[];for(;ri!==records.length;++ri){var record=records[ri].trim().split(":");if(record[0]!=="cell")continue;var addr=decode_cell(record[1]);if(arr.length<=addr.r)for(R=arr.length;R<=addr.r;++R)if(!arr[R])arr[R]=[];R=addr.r;C=addr.c;switch(record[2]){case"t":arr[R][C]=record[3];break;case"v":arr[R][C]=+record[3];break;case"vtc":case"vtf":switch(record[3]){case"nl":arr[R][C]=+record[4]?true:false;break;default:arr[R][C]=+record[4];break}break}}return arr};var socialcalc_to_sheet=function(str){return aoa_to_sheet(socialcalc_to_aoa(str))};var socialcalc_to_workbook=function(str){return sheet_to_workbook(socialcalc_to_sheet(str))};var sc_to_sheet=function(f){throw new Error("SC files unsupported")};var sc_to_workbook=function(str){return sheet_to_workbook(sc_to_sheet(str))};var dbf_codepage_map={1:437,2:850,3:1252,4:1e4,100:852,101:866,102:865,103:861,104:895,105:620,106:737,107:857,120:950,121:949,122:936,123:932,124:874,125:1255,126:1256,150:10007,151:10029,152:10006,200:1250,201:1251,202:1254,203:1253,0:20127,8:865,9:437,10:850,11:437,13:437,14:850,15:437,16:850,17:437,18:850,19:932,20:850,21:437,22:850,23:865,24:437,25:437,26:850,27:437,28:863,29:850,31:852,34:852,35:852,36:860,37:850,38:866,55:850,64:852,77:936,78:949,79:950,80:874,87:1252,88:1252,89:1252,255:16969};var dbf_to_aoa=function(buf){var out=[];if(typeof Buffer==="undefined")throw new Error("Buffer support required for DBF");var d=Buffer.isBuffer(buf)?buf:new Buffer(buf,"binary"),l=0;var ft=d[l++];var memo=false;var vfp=false;switch(ft){case 3:break;case 48:vfp=true;memo=true;break;case 49:vfp=true;break;case 131:memo=true;break;case 139:memo=true;break;case 245:memo=true;break;default:process.exit();throw new Error("DBF Unsupported Version: "+ft.toString(16))}var filedate=new Date(d[l]+1900,d[l+1]-1,d[l+2]);l+=3;var nrow=d.readUInt32LE(l);l+=4;var fpos=d.readUInt16LE(l);l+=2;var rlen=d.readUInt16LE(l);l+=2;l+=16;var flags=d[l++];var current_cp=1252;if(d[l]!==0)current_cp=dbf_codepage_map[d[l]];l+=1;l+=2;var fields=[],field={};var hend=fpos-10-(vfp?264:0);while(l<hend){field={};field.name=d.slice(l,l+11).toString().replace(/[\u0000\r\n].*$/g,"");field.type=String.fromCharCode(d[l+11]);field.offset=d.readUInt32LE(l+12);field.len=d[l+16];field.dec=d[l+17];if(field.name.length)fields.push(field);l+=32;switch(field.type){case"C":break;case"D":break;case"F":break;case"I":break;case"L":break;case"M":break;case"N":break;case"T":break;case"Y":break;case"0":break;case"+":break;case"@":break;default:throw new Error("Unknown Field Type: "+field.type)}}if(d[l]!==13)l=fpos-1;if(d[l++]!==13)throw new Error("DBF Terminator not found "+l+" "+d[l]);l=fpos;var R=0,C=0;out[0]=[];for(C=0;C!=fields.length;++C)out[0][C]=fields[C].name;while(nrow-- >0){if(d[l]===42){l+=rlen;continue}++l;out[++R]=[];C=0;for(C=0;C!=fields.length;++C){var dd=d.slice(l,l+fields[C].len);l+=fields[C].len;var s=cptable.utils.decode(current_cp,dd);switch(fields[C].type){case"C":out[R][C]=cptable.utils.decode(current_cp,dd);break;case"D":if(s.length===8)out[R][C]=new Date(+s.substr(0,4),+s.substr(4,2)-1,+s.substr(6,2));else out[R][C]=s;break;case"F":out[R][C]=parseFloat(s.trim());break;case"I":out[R][C]=dd.readInt32LE(0);break;case"L":switch(s.toUpperCase()){case"Y":case"T":out[R][C]=true;break;case"N":case"F":out[R][C]=false;break;case" ":case"?":out[R][C]=false;break;default:throw new Error("DBF Unrecognized L:|"+s+"|")}break;case"M":if(!memo)throw new Error("DBF Unexpected MEMO for type "+ft.toString(16));out[R][C]="##MEMO##"+dd.readUInt32LE(0);break;case"N":out[R][C]=+s.replace(/\u0000/g,"").trim();break;case"T":var day=dd.readUInt32LE(0),ms=dd.readUInt32LE(4);throw new Error(day+" | "+ms);case"Y":out[R][C]=dd.readInt32LE(0)/1e4;break;case"0":if(fields[C].name==="_NullFlags")break;default:throw new Error("DBF Unsupported data type "+fields[C].type)}}}if(l<d.length&&d[l++]!=26)throw new Error("DBF EOF Marker missing "+(l-1)+" of "+d.length+" "+d[l-1].toString(16));return out};var dbf_to_sheet=function(buf){return aoa_to_sheet(dbf_to_aoa(buf),{dateNF:"yyyymmdd"})};var dbf_to_workbook=function(buf){return sheet_to_workbook(dbf_to_sheet(buf))};function read_str(f,opts,hint){if(hint===65534)return csv_to_workbook(f);if(f.substr(0,5)==="TABLE"&&f.substr(0,12).indexOf("0,1")>-1)return dif_to_workbook(f);else if(f.substr(0,2)==="ID")return sylk_to_workbook(f);else if(f.charCodeAt(2)<=12&&f.charCodeAt(3)<=31)return dbf_to_workbook(new Buffer(f,"binary"));else if(f.substr(0,19)==="socialcalc:version:")return socialcalc_to_workbook(f);else if(f.substr(0,61)=="# This data file was generated by the Spreadsheet Calculator.")return sc_to_workbook(f);else if(f.indexOf(",")!=-1||f.indexOf("\t")!=-1)return csv_to_workbook(f);else return prn_to_workbook(f)}function read_buf(f,opts,hint){if(f[2]<=12&&f[3]<=31)return dbf_to_workbook(f);return read_str(f.toString("binary"),opts)}function read(f,opts,hint){if(Buffer.isBuffer(f))return read_buf(f,opts,hint);return read_str(f,opts,hint)}var readFile=function(f,o){var b=fs.readFileSync(f);if((b[0]<<8|b[1])==65534)return read_str(cptable.utils.decode(1200,b.slice(2)),o,65534);return read_buf(b,o)};function decode_row(rowstr){return parseInt(unfix_row(rowstr),10)-1}function encode_row(row){return""+(row+1)}function fix_row(cstr){return cstr.replace(/([A-Z]|^)(\d+)$/,"$1$$$2")}function unfix_row(cstr){return cstr.replace(/\$(\d+)$/,"$1")}function decode_col(colstr){var c=unfix_col(colstr),d=0,i=0;for(;i!==c.length;++i)d=26*d+c.charCodeAt(i)-64;return d-1}function encode_col(col){var s="";for(++col;col;col=Math.floor((col-1)/26))s=String.fromCharCode((col-1)%26+65)+s;return s}function fix_col(cstr){return cstr.replace(/^([A-Z])/,"$$$1")}function unfix_col(cstr){return cstr.replace(/^\$([A-Z])/,"$1")}function split_cell(cstr){return cstr.replace(/(\$?[A-Z]*)(\$?\d*)/,"$1,$2").split(",")}function decode_cell(cstr){var splt=split_cell(cstr);return{c:decode_col(splt[0]),r:decode_row(splt[1])}}function encode_cell(cell){return encode_col(cell.c)+encode_row(cell.r)}function encode_range(cs,ce){if(typeof ce==="undefined"||typeof ce==="number"){return encode_range(cs.s,cs.e)}if(typeof cs!=="string")cs=encode_cell(cs);if(typeof ce!=="string")ce=encode_cell(ce);return cs==ce?cs:cs+":"+ce}var utils={encode_col:encode_col,encode_row:encode_row,encode_cell:encode_cell,encode_range:encode_range,decode_col:decode_col,decode_row:decode_row,decode_cell:decode_cell};HARB.read=read;HARB.readFile=readFile;HARB.utils=utils})(typeof exports!=="undefined"?exports:HARB);
